{% extends 'webapp/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container bg-light shadow-lg p-3 mb-5 rounded form-layout">
    <h2>Utwórz nowy rekord</h2>
    <br>
    <hr>
    <br>

    <form method="POST" autocomplete="off">
        {% csrf_token %}
        
        <!-- Address search field -->
        <div class="form-group">
            <label for="address-search">Wyszukaj adres:</label>
            <input type="text" id="address-search" class="form-control">
            <ul id="address-results" class="list-group mt-2" style="display: none;"></ul>
        </div>

        <br>
        <br>

        {{ form|crispy }}
        
        <br>
        <div class="btn-group w-100" role="group">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary w-50 p-2">Anuluj &nbsp;&nbsp;<i data-feather="x"></i></a>
            <button type="submit" class="btn btn-primary w-50 p-2">Utwórz &nbsp;&nbsp;<i data-feather="file-plus"></i></button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        console.log('Document ready');
        const addressSearch = $('#address-search');
        const addressResults = $('#address-results');
    
        addressSearch.on('input', function() {
            const query = $(this).val();
            console.log('Input detected:', query);
            
            if (query.length > 2) {
                console.log('Query length > 2, making AJAX call');
                $.ajax({
                    url: '{% url "nominatim_search" %}',
                    data: { 'q': query },
                    success: function(data) {
                        console.log('AJAX success, data:', data);
                        addressResults.empty();
                        if (data.length > 0) {
                            data.forEach(function(item, index) {
                                addressResults.append(`<li class="list-group-item" data-index="${index}">${item.display_name}</li>`);
                            });
                            console.log('Showing results');
                            addressResults.show();
                            // Store the full data array in a data attribute on the parent element
                            addressResults.data('fullAddressData', data);
                        } else {
                            console.log('No results, hiding dropdown');
                            addressResults.hide();
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('AJAX error:', textStatus, errorThrown);
                    }
                });
            } else {
                console.log('Query too short, hiding results');
                addressResults.hide();
            }
        });
    
        // Handle click on address result
        addressResults.on('click', 'li', function() {
            const index = $(this).data('index');
            const fullAddressData = addressResults.data('fullAddressData');
            const addressData = fullAddressData[index];
            console.log('Selected address data:', addressData);
    
            // Fill in the address search field
            addressSearch.val(addressData.display_name);
    
            // Fill in other form fields
            fillAddressFields(addressData);
    
            // Hide the results
            addressResults.hide();
        });
    
        function fillAddressFields(addressData) {
            // Fill in fields based on address components
            $('input[name="address_street"]').val(addressData.address.road || '');
            $('input[name="address_city"]').val(addressData.address.city || addressData.address.town || addressData.address.village || '');
            $('input[name="address_postal_code"]').val(addressData.address.postcode || '');
            $('input[name="address_country"]').val(addressData.address.country || '');
    
            // Fill in GPS coordinates
            $('input[name="gps_latitude"]').val(addressData.lat);
            $('input[name="gps_longitude"]').val(addressData.lon);
    
            // Fill in other address fields if available
            $('input[name="address_building"]').val(addressData.address.house_number || '');
            $('input[name="address_apartment"]').val(''); // Nominatim doesn't provide apartment number
    
            console.log('Address fields filled');
        }
    });
</script>

{% endblock %}